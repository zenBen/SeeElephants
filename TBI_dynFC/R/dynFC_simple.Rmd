---
title: "TBI dynamic FC"
author: "Ben Cowley"
date: "17 March 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '/home/bcowley/Benslab/project_TBI/SeeElephants/TBI_dynFC')
library(tidyverse)
source('read_parse_csv.R')
source('dynFC_functions.R')
```

# DATA WRANGLING

After exporting subject-wise ROIs from Matlab data to csv files, we read all data into a single long-format data structure. We label this data with the condition, 1 = pre, 2 = post

```{r wrangle}
# List of conditions
timecond <- c('pre', 'post')

df <- read_all_recordings('data', pat='ROI_Subject0[0-9][0-9]_Condition000_mock', ext="csv")
df$cond <- rep(c(rep(1, 145), rep(2, 145)), 24)

subjs <- unique(df$Part)
sbjix <- seq(1, length(subjs))
```


# SYNCHRONY COMBINATIONS
Firstly, we work within each ROI combination indicated:
* roi 1 R IFG v roi 2 L HPC x cond 1, 2
* roi 1 R IFG v roi 2 R NAC x cond 1, 2
* roi 1 R ACC v roi 2 L STG x cond 1, 2
* roi 1 R ACC v roi 2 R TPO x cond 1, 2

We calculate a sliding window median smoothing of the rsfMRI data; followed by the correlation matrix for each condition. Correlation matrices show the intra-subject correlations on the diagonal, and inter-subject correlations off-diagonal. Diagonals (n-element vector, n = sample size) and their aggregate (scalar) are obtained for each condition (can be used for, e.g. within-subjects analysis of prognostics?)

To aggregate correlations, we take the mean (note that correlations can only be aggregated this way for constant N; to see why, note that Hunter-Schmidt aggregation is equivalent to average when ). We also take the mean of absolute correlations, to estimate the unsigned magnitude of connectivity. 

We finally plot the correlation matrix for each combination.

```{r correlate}
library(RcppRoll)
library(reshape2)
# s1c1.rifg.lhpc <- corr_rollmed(df, 1, 1, c("roi1_rifg", "roi2_lhpc"), 10, 5)
# c1All.rifg.lhpc <- corr_rollmed_all(df, 1, c("roi1_rifg", "roi2_lhpc"), 10, 5)
# c2all.rifg.lhpc <- corr_rollmed_all(df, 2, c("roi1_rifg", "roi2_lhpc"), 10, 5)

# PRE - TESTS
#####################################
CND = 1

# ROI 1 R IFG x ROI2 L HPC - COND1
all2allc1.rifg.lhpc <- corr_rollmed_all2all(df, CND, c("roi1_rifg", "roi2_lhpc"), 10, 5, FALSE)
allc1.rifg.lhpc <- diag(all2allc1.rifg.lhpc$corr)
avg.c1corr.rifg.lhpc <- mean(allc1.rifg.lhpc)
ab.av.c1cor.rifg.lhpc <- mean(abs(allc1.rifg.lhpc))
ggplot(data = melt(all2allc1.rifg.lhpc$corr), aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(-1,1), space = "Lab", 
                       name="Pearson\nCorrelation") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 12, hjust = 1))+
  coord_fixed()

# ROI 1 R IFG x ROI2 R NAC - COND1
all2allc1.rifg.rnac <- corr_rollmed_all2all(df, CND, c("roi1_rifg", "roi2_rnac"), 10, 5, FALSE)
allc1.rifg.rnac <- diag(all2allc1.rifg.rnac$corr)
avg.c1corr.rifg.rnac <- mean(allc1.rifg.rnac)
ab.av.c1cor.rifg.rnac <- mean(abs(allc1.rifg.rnac))
ggplot(data = melt(all2allc1.rifg.rnac$corr), aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(-1,1), space = "Lab", 
                       name="Pearson\nCorrelation") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 12, hjust = 1))+
  coord_fixed()

# ROI 1 R ACC x ROI2 L STG - COND1
all2allc1.racc.lstg <- corr_rollmed_all2all(df, CND, c("roi1_racc", "roi2_lstg"), 10, 5, FALSE)
allc1.racc.lstg <- diag(all2allc1.racc.lstg$corr)
avg.c1corr.racc.lstg <- mean(allc1.racc.lstg)
ab.av.c1cor.racc.lstg <- mean(abs(allc1.racc.lstg))
ggplot(data = melt(all2allc1.racc.lstg$corr), aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(-1,1), space = "Lab", 
                       name="Pearson\nCorrelation") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 12, hjust = 1))+
  coord_fixed()

# ROI 1 R ACC x ROI2 R TPO - COND1
all2allc1.racc.rtpo <- corr_rollmed_all2all(df, CND, c("roi1_racc", "roi2_rtpo"), 10, 5, FALSE)
allc1.racc.rtpo <- diag(all2allc1.racc.rtpo$corr)
avg.c1corr.racc.rtpo <- mean(allc1.racc.rtpo)
ab.av.c1cor.racc.rtpo <- mean(abs(allc1.racc.rtpo))
ggplot(data = melt(all2allc1.racc.rtpo$corr), aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(-1,1), space = "Lab", 
                       name="Pearson\nCorrelation") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 12, hjust = 1))+
  coord_fixed()


# POST - TESTS
#####################################
CND = 2

# ROI 1 R IFG x ROI2 L HPC - Cond2
all2allc2.rifg.lhpc <- corr_rollmed_all2all(df, CND, c("roi1_rifg", "roi2_lhpc"), 10, 5, FALSE)
allc2.rifg.lhpc <- diag(all2allc2.rifg.lhpc$corr)
avg.c2corr.rifg.lhpc <- mean(allc2.rifg.lhpc)
ab.av.c2cor.rifg.lhpc <- mean(abs(allc2.rifg.lhpc))
ggplot(data = melt(all2allc2.rifg.lhpc$corr), aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(-1,1), space = "Lab", 
                       name="Pearson\nCorrelation") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 12, hjust = 1))+
  coord_fixed()

# ROI 1 R IFG x ROI2 R NAC - Cond2
all2allc2.rifg.rnac <- corr_rollmed_all2all(df, CND, c("roi1_rifg", "roi2_rnac"), 10, 5, FALSE)
allc2.rifg.rnac <- diag(all2allc2.rifg.rnac$corr)
avg.c2corr.rifg.rnac <- mean(allc2.rifg.rnac)
ab.av.c2cor.rifg.rnac <- mean(abs(allc2.rifg.rnac))
ggplot(data = melt(all2allc2.rifg.rnac$corr), aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(-1,1), space = "Lab", 
                       name="Pearson\nCorrelation") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 12, hjust = 1))+
  coord_fixed()

# ROI 1 R ACC x ROI2 L STG - Cond2
all2allc2.racc.lstg <- corr_rollmed_all2all(df, CND, c("roi1_racc", "roi2_lstg"), 10, 5, FALSE)
allc2.racc.lstg <- diag(all2allc2.racc.lstg$corr)
avg.c2corr.racc.lstg <- mean(allc2.racc.lstg)
ab.av.c2cor.racc.lstg <- mean(abs(allc2.racc.lstg))
ggplot(data = melt(all2allc2.racc.lstg$corr), aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(-1,1), space = "Lab", 
                       name="Pearson\nCorrelation") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 12, hjust = 1))+
  coord_fixed()

# ROI 1 R ACC x ROI2 R TPO - Cond2
all2allc2.racc.rtpo <- corr_rollmed_all2all(df, CND, c("roi1_racc", "roi2_rtpo"), 10, 5, FALSE)
allc2.racc.rtpo <- diag(all2allc2.racc.rtpo$corr)
avg.c2corr.racc.rtpo <- mean(allc2.racc.rtpo)
ab.av.c2cor.racc.rtpo <- mean(abs(allc2.racc.rtpo))
ggplot(data = melt(all2allc2.racc.rtpo$corr), aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(-1,1), space = "Lab", 
                       name="Pearson\nCorrelation") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 12, hjust = 1))+
  coord_fixed()
```


# MATRIX SAMPLING

To obtain a random sample (without replacement) of the pair-wise correlations, we simply shuffle the columns of each correlation matrix, which means we destroy matrix symmetry. An example is calculated and displayed below.

```{r matrix-sampling}
samp <- sample_matrix(sbjix, all2allc1.racc.lstg$corr, repl = FALSE)
ggplot(data = melt(samp$sampmat), aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(-1,1), space = "Lab", 
                       name="Pearson\nCorrelation") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 12, hjust = 1))+
  coord_fixed()

```


# PERMUTATION TESTING

To obtain a permutation test statistic, we repeat the random sampling 10000 times, generating a distribution of correlations. We plot the observed real correlation against the distribution to see the statistical difference of the obervation from a random distribution. It is significantly different in 4 of 8 cases.

```{r permutation}
REPS <- 10000

# PRE - TESTS
#####################################
# ROI1 R IFG x ROI2 L HPC - COND1
obsVrand_corr <- replicate(REPS, sampmat_diag_stat(mean, sbjix, all2allc1.rifg.lhpc$corr))
hist(obsVrand_corr, xlim = range(obsVrand_corr, avg.c1corr.rifg.lhpc), col='black', breaks=100, 
     main = paste("ROI1 R IFG x ROI2 L HPC - COND1, two-tailed p =", sum(abs(obsVrand_corr) > abs(avg.c1corr.rifg.lhpc)) / REPS))
abline(v=avg.c1corr.rifg.lhpc, col='blue', lwd=2)

# ROI1 R IFG x ROI2 R NAC - COND1
obsVrand_corr <- replicate(REPS, sampmat_diag_stat(mean, sbjix, all2allc1.rifg.rnac$corr))
hist(obsVrand_corr, xlim = range(obsVrand_corr, avg.c1corr.rifg.rnac), col='black', breaks=100, 
     main = paste("ROI1 R IFG x ROI2 R NAC - COND1, two-tailed p =", sum(abs(obsVrand_corr) > abs(avg.c1corr.rifg.rnac)) / REPS))
abline(v=avg.c1corr.rifg.rnac, col='blue', lwd=2)

# ROI1 R ACC x ROI2 L STG - COND1
obsVrand_corr <- replicate(REPS, sampmat_diag_stat(mean, sbjix, all2allc1.racc.lstg$corr))
hist(obsVrand_corr, xlim = range(obsVrand_corr, avg.c1corr.racc.lstg), col='black', breaks=100, 
     main = paste("ROI1 R ACC x ROI2 L STG - COND1, two-tailed p =", sum(abs(obsVrand_corr) > abs(avg.c1corr.racc.lstg)) / REPS))
abline(v=avg.c1corr.racc.lstg, col='blue', lwd=2)

# ROI1 R ACC x ROI2 R TPO - COND1
obsVrand_corr <- replicate(REPS, sampmat_diag_stat(mean, sbjix, all2allc1.racc.rtpo$corr))
hist(obsVrand_corr, xlim = range(obsVrand_corr, avg.c1corr.racc.rtpo), col='black', breaks=100, 
     main = paste("ROI1 R ACC x ROI2 R TPO - COND1, two-tailed p =", sum(abs(obsVrand_corr) > abs(avg.c1corr.racc.rtpo)) / REPS))
abline(v=avg.c1corr.racc.rtpo, col='blue', lwd=2)


# POST - TESTS
#####################################
# ROI1 R IFG x ROI2 L HPC - COND2
obsVrand_corr <- replicate(REPS, sampmat_diag_stat(mean, sbjix, all2allc2.rifg.lhpc$corr))
hist(obsVrand_corr, xlim = range(obsVrand_corr, avg.c2corr.rifg.lhpc), col='black', breaks=100, 
     main = paste("ROI1 R IFG x ROI2 L HPC - COND2, two-tailed p =", sum(abs(obsVrand_corr) > abs(avg.c2corr.rifg.lhpc)) / REPS))
abline(v=avg.c2corr.rifg.lhpc, col='blue', lwd=2)

# ROI1 R IFG x ROI2 R NAC - COND2
obsVrand_corr <- replicate(REPS, sampmat_diag_stat(mean, sbjix, all2allc2.rifg.rnac$corr))
hist(obsVrand_corr, xlim = range(obsVrand_corr, avg.c2corr.rifg.rnac), col='black', breaks=100, 
     main = paste("ROI1 R IFG x ROI2 R NAC - COND2, two-tailed p =", sum(abs(obsVrand_corr) > abs(avg.c2corr.rifg.rnac)) / REPS))
abline(v=avg.c2corr.rifg.rnac, col='blue', lwd=2)

# ROI1 R ACC x ROI2 L STG - COND2
obsVrand_corr <- replicate(REPS, sampmat_diag_stat(mean, sbjix, all2allc2.racc.lstg$corr))
hist(obsVrand_corr, xlim = range(obsVrand_corr, avg.c2corr.racc.lstg), col='black', breaks=100, 
     main = paste("ROI1 R ACC x ROI2 L STG - COND2, two-tailed p =", sum(abs(obsVrand_corr) > abs(avg.c2corr.racc.lstg)) / REPS))
abline(v=avg.c2corr.racc.lstg, col='blue', lwd=2)

# ROI1 R ACC x ROI2 R TPO - COND2
obsVrand_corr <- replicate(REPS, sampmat_diag_stat(mean, sbjix, all2allc2.racc.rtpo$corr))
hist(obsVrand_corr, xlim = range(obsVrand_corr, avg.c2corr.racc.rtpo), col='black', breaks=100, 
     main = paste("ROI1 R ACC x ROI2 R TPO - COND2, two-tailed p =", sum(abs(obsVrand_corr) > abs(avg.c2corr.racc.rtpo)) / REPS))
abline(v=avg.c2corr.racc.rtpo, col='blue', lwd=2)

```